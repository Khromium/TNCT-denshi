mp4ex02.txt


1.課題
8bitスイッチの回路図を見ると，CPUの端子からスイッチを経てGNDに接続されているだけである。
通常はこの回路ではスイッチの状態を読み取ることができない。
スイッチを読み取るプログラムの初期化部分の意味（8bitSWのプルアップ設定）とあわせてどうして可能なのか検討し，説明しなさい。
なおH8/3048foneハードウェアマニュアルの関連する説明を抜き出しなさい。（９．３ ポート2参照）
また小坂のweb文書「h8CPU_Input.html」も参考にしなさい。


2.使用したプログラム
 /**********************************************************
8ビットスイッチによってLEDのON-OFFを行う
**********************************************************/
#include <3048fone.h>
#include "h8_3048fone.h"

void waitmsec(int msec)
/*msec間なにもしない時間稼ぎ関数*/
{
    int i,j;
    for (i=0;i<msec;i++) {
        for (j=0;j<4190;j++);    /*4190は実測によって求めた値 25MHz駆動*/
    }
}

main()
{
    initLed();
    P2.DDR = 0;
	P2.PCR.BYTE = 0xff;/*8bitSWのプルアップ設定*/
    while(1) {
        if (P2.DR.BIT.B0==0) { /*8bitSWの0がONの時*/
            turnOnLed(0);
            turnOnLed(1);
        } else if (P2.DR.BIT.B1==0) { /*8bitSWの1がONの時*/
            turnOnLed(0);
            turnOffLed(1);
        } else if (P2.DR.BIT.B2==0) { /*8bitSWの2がONの時*/
            turnOffLed(0);
            turnOnLed(1);
        } else {
            turnOffLed(0);
            turnOffLed(1);
        }
    }
}
3.考察
P2.PCR.BYTE = 0xffを最初にすることで8bitSWの入力プルアップMOSコントロールレジスタに1をセットされ，8bitSWの値を読むことができるようになる．
プルアップ抵抗を有効にするとSWがONでGNDにつながっているときは0，OFFでつながっていないときは1の値が読み取ることが可能である．

H8/3048foneハードウェアマニュアルの関連する説明
P2PCR は 8 ビットのリード／ライト可能なレジスタで、ポート 2 に内蔵した入力プルアップ MOSをビットごとに制御します。
モード 5〜7 のとき、P2DDR を 0 にクリアした（入力ポートの）状態で P2PCR を 1 にセットすると対応するビットの入力プルアップ MOS は ON します。
P2PCR は、リセット、またはハードウェアスタンバイモード時に、H'00 にイニシャライズされます。ソフトウェアスタンバイモード時には、直前の状態を保持します。

4.まとめ
課題通りにプログラムが動作した．